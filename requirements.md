# Claude Watch 项目测试需求文档

## 项目概述

**项目名称**: claude-watch  
**项目类型**: Rust CLI 应用，用于监控 Claude Code 工作状态  
**版本**: v1.0.2  
**测试目标**: 确保监控系统的准确性、稳定性和可靠性  

## 测试范围

### 核心功能模块
1. **活动检测模块** (`activity.rs`) - 检测 Claude Code 是否活跃
2. **监控循环模块** (`monitor.rs`) - 核心监控逻辑和状态管理
3. **LLM 集成模块** (`llm.rs`) - 状态判断和智能激活
4. **配置管理模块** (`config.rs`) - 配置加载和验证
5. **Tmux 交互模块** (`tmux.rs`) - tmux 窗格通信
6. **参数解析模块** (`args.rs`) - 命令行参数处理

### 外部依赖
- **Ollama**: 本地 LLM 服务
- **OpenAI/OpenRouter**: 云端 LLM 服务
- **tmux**: 终端复用器
- **系统命令**: shell 命令执行

## 功能性需求

### FR-001: 活动状态检测
**描述**: 准确识别 Claude Code 的各种活动状态
**优先级**: 高

**验收标准**:
- [x] 能识别标准执行条格式: `*(状态)… (时间 · tokens · esc to interrupt)`
- [x] 能识别工具调用状态: `Tool use`, `Calling tool`, `Function call`
- [x] 能识别文件操作状态: `Reading file`, `Writing file`, `Creating file`
- [x] 能识别思考状态: `Cogitating`, `Thinking`, `Herding`, `Meandering`
- [x] 能识别编译状态: `Compiling`, `Building`, `Processing`
- [x] 能识别重试和命令: `Retry`, `/compact`, `Escaping`
- [x] 能识别进度指示器: `▪▪▪`, `◦◦◦`, `>>>`, `***`
- [x] 正确处理 Done 状态（不认为是活动状态）
- [x] 支持多行文本检测
- [x] 边界情况处理（空输入、无效格式等）

### FR-002: 时间变化检测
**描述**: 检测 Claude Code 执行时间的递增变化
**优先级**: 高

**验收标准**:
- [ ] 能从复杂格式中提取时间值: `(343s)`, `(169s)`, `(56s)`
- [ ] 支持多个独立窗格的时间追踪
- [ ] 正确判断时间是否递增
- [ ] 处理时间格式错误和无效输入
- [ ] 线程安全的时间状态管理
- [ ] 性能优化（避免频繁的内存分配）

### FR-003: 跳过 LLM 调用判断
**描述**: 智能判断是否应该跳过 LLM 调用，避免误判
**优先级**: 高

**验收标准**:
- [x] 识别明确的中断状态: `Interrupted by user`, `Aborted by user`
- [x] 识别命令提示符状态: `$`, `>`, `#`
- [x] 识别标准执行条格式（有 tokens）
- [x] 识别未完成输出指示符: `...`, `▪`, `◦`, `●`
- [x] 识别活动状态关键词: `Cogitating`, `Processing`, `Reading`, `Calling`
- [x] 识别时间计数器但有活动的情况
- [x] 正确区分空闲状态和卡住状态

### FR-004: 实质性进展检测
**描述**: 区分真正的活动恢复和虚假的时间计数器变化
**优先级**: 高

**验收标准**:
- [x] 识别新的思考状态: `Cogitating`, `Thinking`, `分析中`
- [x] 识别新的工具调用: `Tool use`, `Function call`
- [x] 识别新的文件操作: `Reading file`, `Writing file`
- [x] 识别新的处理状态: `Compiling`, `Building`, `Installing`
- [x] 识别命令执行: `$`, `>`, `#`
- [x] 识别完成指示: `✅`, `完成`, `Finished`
- [x] 识别错误状态: `Error:`, `error:`, `Failed`
- [x] 区分长文本输出和纯时间计数器

### FR-005: LLM 状态判断
**描述**: 使用 LLM 准确判断 Claude Code 的最终状态
**优先级**: 高

**验收标准**:
- [ ] 支持 Ollama 后端调用
- [ ] 支持 OpenAI 兼容 API 调用
- [ ] 支持 OpenRouter 服务调用
- [ ] 正确解析 LLM 响应（DONE/STUCK）
- [ ] 处理 LLM 调用失败和网络错误
- [ ] 异步调用优化（避免 Tokio 冲突）
- [ ] 简化的启发式检查（LLM 不可用时）

### FR-006: 智能激活功能
**描述**: 当 Claude Code 卡住时，使用 LLM 生成激活消息
**优先级**: 中

**验收标准**:
- [ ] 生成自然、友好的激活消息
- [ ] 支持多种 LLM 后端
- [ ] 验证激活效果
- [ ] 失败时回退到传统 Retry 命令
- [ ] 消息长度和内容控制

### FR-007: 配置管理系统
**描述**: 灵活的配置加载和管理
**优先级**: 中

**验收标准**:
- [ ] 支持配置文件加载（YAML 格式）
- [ ] 支持命令行参数覆盖
- [ ] 支持环境变量配置
- [ ] 配置验证和默认值处理
- [ ] 多后端配置（Ollama、OpenAI、OpenRouter）
- [ ] 监控参数配置（间隔、超时、重试次数）

### FR-008: Tmux 交互功能
**描述**: 与 tmux 窗格的可靠通信
**优先级**: 中

**验收标准**:
- [ ] 可靠的文本发送（分步发送避免时序问题）
- [ ] 准确的内容捕获
- [ ] 错误处理和状态反馈
- [ ] 支持各种窗格标识符格式
- [ ] 处理 tmux 命令失败情况

### FR-009: 监控循环逻辑
**描述**: 核心监控流程的状态管理
**优先级**: 高

**验收标准**:
- [ ] 定时检查机制
- [ ] 超时判断逻辑
- [ ] 重试计数管理
- [ ] 完成状态监控模式
- [ ] 高级恢复策略
- [ ] 守护模式处理
- [ ] 内容变化检测（忽略无意义变化）

### FR-010: 参数解析和验证
**描述**: 命令行参数的解析和验证
**优先级**: 低

**验收标准**:
- [ ] 支持所有必需参数（pane、backend、interval、stuck_sec、max_retry）
- [ ] 参数类型验证
- [ ] 默认值处理
- [ ] 帮助信息生成
- [ ] 错误提示

## 非功能性需求

### NFR-001: 性能要求
**描述**: 系统响应时间和资源使用
**优先级**: 高

**指标要求**:
- 活动检测响应时间 < 10ms
- 内容变化检测 < 50ms（长文本）
- LLM 调用超时时间 < 30s
- 内存使用 < 50MB（正常运行）
- CPU 使用率 < 5%（空闲状态）

### NFR-002: 可靠性要求
**描述**: 系统稳定性和错误处理
**优先级**: 高

**指标要求**:
- 24/7 稳定运行能力
- 网络异常自动恢复
- LLM 服务不可用时的降级处理
- tmux 连接断开的重连机制
- 配置错误时的优雅降级

### NFR-003: 测试覆盖率
**描述**: 代码测试覆盖要求
**优先级**: 高

**指标要求**:
- 整体代码覆盖率 > 80%
- 核心模块覆盖率 > 90%
- 集成测试覆盖率 > 70%
- 边界条件测试覆盖率 > 85%

### NFR-004: 可维护性要求
**描述**: 代码质量和文档
**优先级**: 中

**指标要求**:
- 所有函数都有文档注释
- 复杂逻辑有详细注释
- 测试用例有清晰的场景描述
- 错误信息友好且可操作
- 代码结构清晰，模块职责明确

### NFR-005: 兼容性要求
**描述**: 环境和依赖兼容性
**优先级**: 中

**指标要求**:
- 支持 Rust 1.70+
- 支持 Linux/macOS 系统
- 支持 tmux 3.0+
- 支持 Ollama 0.1.0+
- 兼容多种 OpenAI 兼容服务

## 测试环境配置

### 开发环境
- **操作系统**: Linux (推荐 Ubuntu 20.04+)
- **Rust 版本**: 1.70+
- **tmux 版本**: 3.0+
- **测试工具**: cargo, cargo-nextest（可选）

### 测试依赖
- **Ollama**: 本地测试用的 LLM 服务
- **Mock 服务**: 用于模拟外部依赖
- **测试数据**: 真实的 Claude Code 输出样本
- **测试 tmux 会话**: 用于集成测试

### 测试数据管理
- **真实数据**: 从 tmux 捕获的真实 Claude Code 输出
- **边界数据**: 各种边界和异常情况的测试数据
- **性能数据**: 大文本和复杂场景的测试数据
- **版本控制**: 测试数据的版本管理和更新

## 测试策略

### 单元测试策略
1. **模块独立测试**: 每个模块独立测试，避免外部依赖
2. **Mock 对象**: 使用 mock 替代外部服务（LLM、tmux）
3. **边界测试**: 重点测试边界条件和异常情况
4. **性能测试**: 关键路径的性能基准测试

### 集成测试策略
1. **端到端测试**: 完整的监控流程测试
2. **真实场景测试**: 使用真实的 Claude Code 输出数据
3. **故障注入测试**: 模拟各种故障情况
4. **长期运行测试**: 验证稳定性和内存泄漏

### 测试自动化
1. **CI/CD 集成**: GitHub Actions 自动化测试
2. **测试报告**: 覆盖率报告和性能报告
3. **回归测试**: 每次代码变更的自动回归测试
4. **性能监控**: 关键性能指标的持续监控

## 风险评估

### 技术风险
- **外部依赖风险**: LLM 服务不稳定
- **并发风险**: 多线程状态管理
- **性能风险**: 长时间运行的性能问题
- **兼容性风险**: 不同环境的兼容性问题

### 缓解措施
- **降级策略**: LLM 不可用时的启发式判断
- **重试机制**: 网络和服务的自动重试
- **监控告警**: 性能和错误监控
- **兼容性测试**: 多环境的兼容性验证

## 测试交付物

### 测试文档
- 本测试需求文档
- 测试用户故事文档
- 测试验收标准文档
- 测试执行计划和报告

### 测试代码
- 单元测试代码
- 集成测试代码
- 性能测试代码
- Mock 和测试工具

### 测试数据
- 真实场景测试数据
- 边界条件测试数据
- 性能测试数据集
- 测试数据生成工具

## 成功标准

### 功能完整性
- [ ] 所有功能性需求 100% 实现
- [ ] 所有验收标准 100% 通过
- [ ] 核心场景 100% 覆盖

### 质量标准
- [ ] 代码覆盖率 > 80%
- [ ] 关键模块覆盖率 > 90%
- [ ] 无严重内存泄漏
- [ ] 性能指标达标

### 稳定性标准
- [ ] 24 小时稳定运行测试通过
- [ ] 故障恢复测试通过
- [ ] 资源使用稳定
- [ ] 错误处理完善

---
**文档版本**: v1.0  
**创建日期**: 2025-08-14  
**最后更新**: 2025-08-14  
**负责人**: spec-analyst