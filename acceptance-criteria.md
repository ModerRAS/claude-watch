# Claude Watch 测试验收标准

## 总体验收标准

### 总体成功标准
- **功能完整性**: 所有功能性需求 100% 实现并通过测试
- **代码质量**: 代码覆盖率 > 80%，核心模块 > 90%
- **性能指标**: 所有性能要求达标
- **稳定性**: 24 小时稳定运行测试通过
- **错误处理**: 所有错误场景都有适当的处理机制

### 测试环境要求
- **操作系统**: Linux (Ubuntu 20.04+)
- **Rust 版本**: 1.70+
- **tmux 版本**: 3.0+
- **测试依赖**: 所有开发依赖正确安装
- **测试数据**: 真实场景测试数据准备就绪

## 模块验收标准

### AC-001: 活动检测模块 (activity.rs)

#### AC-001.1: 标准执行条格式检测
**验收标准**: 
- [x] 能正确识别 `*(状态)… (时间 · tokens · esc to interrupt)` 格式
- [x] 支持所有标准状态关键词: `Cogitating`, `Thinking`, `Herding`, `Meandering`, `Reticulating`
- [x] 正确处理 `Done` 状态（不认为是活动状态）
- [x] 处理多行文本中的执行条格式
- [x] 边界情况：空输入、无效格式、部分匹配

**测试用例要求**:
```rust
// 正确识别的案例
"* Herding… (343s · ↑ 14.2k tokens · esc to interrupt)" -> true
"* Cogitating… (169s · ↓ 8.7k tokens · esc to interrupt)" -> true
"* Processing… (56s · ↑ 2.1k tokens · esc to interrupt)" -> true

// 错误处理的案例
"* Done… (123s · ↑ 1k tokens · esc to interrupt)" -> false
"Invalid format" -> false
"" -> false
```

**通过标准**: 所有测试用例 100% 通过，覆盖率 > 95%

---

#### AC-001.2: 工具调用状态检测
**验收标准**:
- [x] 能识别 `Tool use:`, `Calling tool:`, `Function call:` 状态
- [x] 能识别文件操作: `Reading file`, `Writing file`, `Creating file`, `Editing file`
- [x] 能识别命令: `Retry`, `/compact`
- [x] 能识别进度指示器: `▪▪▪`, `◦◦◦`, `>>>`, `***`
- [x] 只检查最后 15 行文本
- [x] 正确处理中英文混合内容

**测试用例要求**:
```rust
// 工具调用检测
"Tool use: Reading file" -> true
"Calling tool: function_name" -> true
"Reading file: src/main.rs" -> true

// 命令检测
"Retry" -> true
"/compact" -> true

// 进度指示器
"▪▪▪" -> true
"◦◦◦" -> true
```

**通过标准**: 识别准确率 > 95%，误报率 < 2%

---

### AC-002: 监控模块 (monitor.rs)

#### AC-002.1: 时间提取功能
**验收标准**:
- [ ] 能从复杂格式中提取时间值: `(343s)`, `(169s)`, `(56s)`
- [ ] 处理无效格式: `(not-a-number s)`, `no time here`
- [ ] 正则表达式编译和缓存优化
- [ ] 性能要求: 单次提取 < 1ms

**测试用例要求**:
```rust
// 正确提取
"(343s)" -> Some(343)
"(169s)" -> Some(169)
"(56s)" -> Some(56)

// 无效情况
"(not-a-number s)" -> None
"no time here" -> None
"" -> None
```

**通过标准**: 所有测试用例通过，性能达标

---

#### AC-002.2: 时间递增检测
**验收标准**:
- [ ] 支持多个独立窗格的时间追踪
- [ ] 正确判断时间递增: 343s -> 344s = true
- [ ] 正确处理时间不变或减少: 343s -> 343s = false
- [ ] 线程安全的状态管理
- [ ] 处理首次记录时间的情况

**测试用例要求**:
```rust
// 时间递增
// 第一次: "* Herding… (343s)" -> true (首次记录)
// 第二次: "* Herding… (344s)" -> true (时间递增)
// 第三次: "* Herding… (344s)" -> false (时间不变)

// 多窗格独立
// pane1: "* Herding… (100s)" -> true
// pane2: "* Cogitating… (200s)" -> true
```

**通过标准**: 状态管理正确，无竞争条件

---

#### AC-002.3: 跳过 LLM 调用判断
**验收标准**:
- [x] 识别明确中断状态: `Interrupted by user` -> 不跳过
- [x] 识别命令提示符状态: `$`, `>`, `#` -> 跳过
- [x] 识别标准执行条格式 -> 跳过
- [x] 识别活动状态关键词 -> 跳过
- [x] 识别未完成输出指示符 -> 跳过
- [x] 判断逻辑的准确性和一致性

**测试用例要求**:
```rust
// 不跳过的情况
"Interrupted by user" -> false
"Aborted by user" -> false

// 跳过的情况
"* Herding… (343s · ↑ 14.2k tokens · esc to interrupt)" -> true
"Cogitating...\nThinking..." -> true
"$ ls -la" -> true
"Ends with..." -> true
```

**通过标准**: 判断准确率 > 90%，关键场景 100% 正确

---

#### AC-002.4: 实质性进展检测
**验收标准**:
- [x] 识别新的思考状态: `Cogitating`, `Thinking`, `分析中`
- [x] 识别新的工具调用: `Tool use`, `Function call`
- [x] 识别新的文件操作: `Reading file`, `Writing file`
- [x] 识别新的处理状态: `Compiling`, `Building`, `Installing`
- [x] 识别命令执行: `$`, `>`, `#`
- [x] 识别完成指示: `✅`, `完成`, `Finished`
- [x] 识别错误状态: `Error:`, `error:`, `Failed`
- [x] 区分长文本输出和纯时间计数器

**测试用例要求**:
```rust
// 有进展的情况
"Cogitating... some content" -> true
"Tool use: Reading file" -> true
"$ ls -la" -> true
"✅ Task completed" -> true
"Error: compilation failed" -> true

// 无进展的情况
"* 104s" -> false (纯时间计数器)
"* 105s" -> false
"Just some text" -> false (短文本)
```

**通过标准**: 进展检测准确率 > 90%，误报率 < 5%

---

### AC-003: LLM 集成模块 (llm.rs)

#### AC-003.1: LLM 状态判断
**验收标准**:
- [ ] 支持 Ollama 后端调用
- [ ] 支持 OpenAI 兼容 API 调用
- [ ] 支持 OpenRouter 服务调用
- [ ] 正确解析 LLM 响应（DONE/STUCK）
- [ ] 处理 LLM 调用失败和网络错误
- [ ] 异步调用优化（避免 Tokio 冲突）
- [ ] 简化的启发式检查（LLM 不可用时）

**测试用例要求**:
```rust
// LLM 调用成功
// 返回 "DONE" -> TaskStatus::Done
// 返回 "STUCK" -> TaskStatus::Stuck

// LLM 调用失败
// 网络错误 -> 使用启发式检查
// 服务不可用 -> 使用启发式检查

// 启发式检查
// "✅ All checks passed" -> TaskStatus::Done
// "Error: compilation failed" -> TaskStatus::Stuck
```

**通过标准**: LLM 集成正确，降级机制有效

---

#### AC-003.2: 智能激活功能
**验收标准**:
- [ ] 生成自然、友好的激活消息
- [ ] 支持多种 LLM 后端
- [ ] 验证激活效果
- [ ] 失败时回退到传统 Retry 命令
- [ ] 消息长度控制（10-20个字）
- [ ] 避免负面词汇

**测试用例要求**:
```rust
// 激活消息生成
// 生成的消息应该友好自然
// 消息长度: 10-20个字
// 不包含: "卡住", "错误", "问题"

// 激活效果验证
// 发送激活消息后检测实质性进展
// 失败时回退到 "Retry" 命令
```

**通过标准**: 激活成功率 > 70%，消息质量达标

---

### AC-004: 配置管理模块 (config.rs)

#### AC-004.1: 配置文件管理
**验收标准**:
- [ ] 支持配置文件加载（YAML 格式）
- [ ] 支持命令行参数覆盖
- [ ] 支持环境变量配置
- [ ] 配置验证和默认值处理
- [ ] 多后端配置（Ollama、OpenAI、OpenRouter）
- [ ] 监控参数配置（间隔、超时、重试次数）

**测试用例要求**:
```rust
// 配置文件加载
// valid_config.yaml -> 成功加载
// invalid_config.yaml -> 使用默认配置
// missing_config.yaml -> 使用默认配置

// 环境变量
// OLLAMA_URL=http://localhost:11434 -> 正确设置
// OPENAI_API_KEY=sk-xxx -> 正确设置

// 命令行参数
// --backend ollama --pane %6 -> 正确覆盖
```

**通过标准**: 配置管理 100% 正确，错误处理完善

---

### AC-005: Tmux 交互模块 (tmux.rs)

#### AC-005.1: Tmux 内容捕获
**验收标准**:
- [ ] 准确捕获 tmux 窗格内容
- [ ] 处理窗格不存在的情况
- [ ] 支持各种窗格标识符格式
- [ ] 处理大文本内容
- [ ] 错误处理和状态反馈

**测试用例要求**:
```rust
// 内容捕获
// capture("%6") -> 返回窗格内容
// capture("invalid_pane") -> 返回错误信息

// 窗格标识符格式
// "%0" -> 支持标准格式
// "session:window.pane" -> 支持完整格式
```

**通过标准**: 捕获功能 100% 可靠，错误处理完善

---

#### AC-005.2: Tmux 命令发送
**验收标准**:
- [ ] 分两步发送（先文本后回车）
- [ ] 150ms 延迟确保接收
- [ ] 错误处理和状态反馈
- [ ] 支持特殊字符和长命令
- [ ] 发送失败的重试机制

**测试用例要求**:
```rust
// 命令发送
// send_keys("Hello", "%6") -> 发送成功
// send_keys("Retry", "%6") -> 发送成功
// send_keys("", "%6") -> 处理空命令

// 错误处理
// send_keys("command", "invalid_pane") -> 错误信息
```

**通过标准**: 发送成功率 > 95%，错误处理完善

---

### AC-006: 监控循环 (monitor.rs)

#### AC-006.1: 监控循环逻辑
**验收标准**:
- [ ] 稳定的监控循环
- [ ] 超时判断和重试逻辑
- [ ] 完成状态监控模式
- [ ] 高级恢复策略
- [ ] 守护模式处理
- [ ] 长时间运行稳定性

**测试用例要求**:
```rust
// 监控循环
// 正常工作状态 -> 持续监控
// 超时状态 -> 触发 LLM 判断
// 完成状态 -> 进入完成监控模式
// 卡住状态 -> 触发恢复策略

// 长时间运行
// 运行 24 小时无内存泄漏
// 运行 24 小时无性能下降
```

**通过标准**: 24 小时稳定运行，所有状态处理正确

---

#### AC-006.2: 内容变化检测
**验收标准**:
- [ ] 忽略无意义变化（时间、tokens）
- [ ] 检测实质性内容变化
- [ ] 性能优化（避免频繁处理）
- [ ] 正则表达式替换准确性
- [ ] 内存使用优化

**测试用例要求**:
```rust
// 内容变化检测
// 时间变化: "343s" -> "344s" -> 无变化
// tokens变化: "↑ 14.2k tokens" -> "↑ 14.3k tokens" -> 无变化
// 实质性变化: "Tool use: Reading file" -> 有变化

// 性能要求
// 处理 10KB 文本 < 50ms
// 处理 100KB 文本 < 500ms
```

**通过标准**: 变化检测准确率 > 95%，性能达标

---

## 性能验收标准

### AC-901: 响应时间要求
**验收标准**:
- [ ] 活动检测响应时间 < 10ms
- [ ] 内容变化检测 < 50ms（长文本）
- [ ] LLM 调用超时时间 < 30s
- [ ] 配置加载时间 < 100ms
- [ ] tmux 操作响应时间 < 100ms

**测试方法**:
```rust
// 基准测试
#[bench]
fn bench_activity_detection(b: &mut test::Bencher) {
    b.iter(|| {
        is_claude_active("* Herding… (343s · ↑ 14.2k tokens · esc to interrupt)")
    });
}

// 性能要求
// activity_detection: < 10ms
// content_change_detection: < 50ms (10KB text)
// llm_call_timeout: 30s
```

**通过标准**: 所有性能指标 100% 达标

---

### AC-902: 资源使用要求
**验收标准**:
- [ ] 内存使用 < 50MB（正常运行）
- [ ] CPU 使用率 < 5%（空闲状态）
- [ ] 24 小时运行无内存泄漏
- [ ] 24 小时运行无 CPU 增长
- [ ] 文件描述符使用正常

**测试方法**:
```rust
// 内存使用监控
// 运行 24 小时，定期检查内存使用
// 使用 Valgrind 检测内存泄漏
// 监控文件描述符数量

// 资源限制
// max_memory: 50MB
// max_cpu: 5% (idle)
// max_fd: 100
```

**通过标准**: 资源使用稳定，无泄漏

---

## 稳定性验收标准

### AC-903: 错误处理要求
**验收标准**:
- [ ] 网络异常自动恢复
- [ ] LLM 服务不可用降级处理
- [ ] tmux 连接断开重连
- [ ] 配置错误优雅降级
- [ ] 所有错误场景都有处理

**测试方法**:
```rust
// 错误注入测试
// 模拟网络断开 -> 自动恢复
// 模拟 LLM 服务不可用 -> 降级到启发式
// 模拟 tmux 断开 -> 重连机制
// 模拟配置错误 -> 优雅降级
```

**通过标准**: 错误恢复率 > 95%，系统稳定性好

---

### AC-904: 兼容性要求
**验收标准**:
- [ ] 支持 Rust 1.70+
- [ ] 支持 Linux/macOS 系统
- [ ] 支持 tmux 3.0+
- [ ] 支持 Ollama 0.1.0+
- [ ] 兼容多种 OpenAI 兼容服务

**测试方法**:
```rust
// 兼容性测试
// Rust 1.70, 1.71, 1.72 -> 编译通过
// Ubuntu 20.04, 22.04 -> 运行正常
// tmux 3.0, 3.1, 3.2 -> 功能正常
// Ollama 0.1.0, 0.1.1 -> 集成正常
```

**通过标准**: 所有兼容性要求 100% 满足

---

## 测试覆盖率验收标准

### AC-905: 代码覆盖率要求
**验收标准**:
- [ ] 整体代码覆盖率 > 80%
- [ ] 核心模块覆盖率 > 90%
- [ ] 集成测试覆盖率 > 70%
- [ ] 边界条件测试覆盖率 > 85%
- [ ] 错误路径测试覆盖率 > 80%

**覆盖率细分**:
```
activity.rs: > 95%
monitor.rs: > 90%
llm.rs: > 85%
config.rs: > 80%
tmux.rs: > 80%
args.rs: > 75%
```

**测试方法**:
```bash
# 生成覆盖率报告
cargo tarpaulin --out Html

# 检查覆盖率
# activity.rs: 95%
# monitor.rs: 90%
# llm.rs: 85%
# config.rs: 80%
# tmux.rs: 80%
# args.rs: 75%
```

**通过标准**: 覆盖率指标 100% 达标

---

## 集成测试验收标准

### AC-906: 端到端测试要求
**验收标准**:
- [ ] 完整监控流程测试通过
- [ ] 状态转换测试通过
- [ ] 故障恢复测试通过
- [ ] 真实场景测试通过
- [ ] 长时间运行测试通过

**测试场景**:
```rust
// 端到端测试场景
// 1. 正常工作状态监控
// 2. 超时检测和 LLM 判断
// 3. 卡住检测和激活恢复
// 4. 完成状态监控
// 5. 错误处理和恢复

// 真实场景测试
// 使用从 tmux 捕获的真实数据
// 测试各种 Claude Code 状态
// 验证监控准确性
```

**通过标准**: 所有集成测试场景 100% 通过

---

## 文档验收标准

### AC-907: 文档完整性要求
**验收标准**:
- [ ] 所有函数都有文档注释
- [ ] 复杂逻辑有详细注释
- [ ] 测试用例有清晰的场景描述
- [ ] 错误信息友好且可操作
- [ ] 用户文档完整

**文档要求**:
```rust
/// 函数文档示例
/// 
/// 检测 Claude Code 特定的活动模式
/// 
/// # 参数
/// * `text` - 要检测的文本内容
/// 
/// # 返回值
/// * `true` - 检测到活动状态
/// * `false` - 未检测到活动状态
/// 
/// # 示例
/// ```
/// let result = is_claude_active("* Herding… (343s · ↑ 14.2k tokens · esc to interrupt)");
/// assert_eq!(result, true);
/// ```
pub fn is_claude_active(text: &str) -> bool {
    // 实现
}
```

**通过标准**: 文档覆盖率 > 90%，质量达标

---

## 验收测试流程

### 阶段 1: 单元测试验收
1. 运行所有单元测试: `cargo test`
2. 检查测试覆盖率: `cargo tarpaulin`
3. 性能基准测试: `cargo bench`
4. 验收标准: 所有测试通过，覆盖率达标

### 阶段 2: 集成测试验收
1. 运行集成测试: `cargo test --test integration`
2. 端到端测试: 模拟完整监控流程
3. 真实场景测试: 使用真实数据
4. 验收标准: 集成测试 100% 通过

### 阶段 3: 系统测试验收
1. 长时间运行测试: 24 小时稳定性测试
2. 资源使用测试: 内存和 CPU 监控
3. 错误恢复测试: 各种故障场景
4. 验收标准: 系统稳定，资源使用正常

### 阶段 4: 验收测试
1. 功能验收: 所有需求 100% 实现
2. 性能验收: 所有性能指标达标
3. 质量验收: 代码质量和文档达标
4. 验收标准: 项目整体验收通过

---

## 验收测试报告

### 测试报告模板
```
# Claude Watch 验收测试报告

## 测试概览
- 测试日期: 2025-08-14
- 测试版本: v1.0.2
- 测试环境: Ubuntu 20.04, Rust 1.70

## 测试结果
### 单元测试
- 通过率: 100%
- 覆盖率: 85%
- 性能: 达标

### 集成测试
- 通过率: 100%
- 场景覆盖: 完整
- 真实数据: 通过

### 系统测试
- 稳定性: 24小时无故障
- 资源使用: 正常
- 错误恢复: 完善

## 验收结论
✅ 功能完整性: 100%
✅ 性能指标: 达标
✅ 稳定性: 通过
✅ 代码质量: 达标

## 最终结论
项目验收通过，可以投入使用。
```

### 验收签字
- **开发负责人**: _______________
- **测试负责人**: _______________
- **产品负责人**: _______________
- **验收日期**: _______________

---
**文档版本**: v1.0  
**创建日期**: 2025-08-14  
**最后更新**: 2025-08-14  
**负责人**: spec-analyst